\documentclass[useAMS,usenatbib]{mn2e}
\usepackage{footnote,graphicx,natbib,color,multirow,amsmath,url,amssymb,tabularx,hyperref,amssymb, mathtools}
\usepackage{aas_macros}

\hypersetup{draft,
    colorlinks,
    citecolor=blue,
    filecolor=black,
    linkcolor=black,
    urlcolor=black
}

\def\lesssim{\mathrel{\hbox{\rlap{\hbox{\lower3pt\hbox{$\sim$}}}\hbox{\raise2pt\hbox{$<$}}}}}

\definecolor{check}{rgb}{1,0,0}
\def\check		{\color{check}}

\begin{document}

\title[There's something about \textsc{starpies}]{There's something about STARPIES}
\author[Smethurst et al. 2018]{R. ~J. ~Smethurst,$^{1}$ C. ~J. ~Lintott,$^{2}$ et al.
\\ $^1$ School of Physics and Astronomy, The University of Nottingham, University Park, Nottingham, NG7 2RD, UK
\\ $^2$ Oxford Astrophysics, Department of Physics, University of Oxford, Denys Wilkinson Building, Keble Road, Oxford, OX1 3RH, UK
}

\maketitle

\begin{abstract}
We present \textsc{starpies}, an open source code writte in \emph{Python}, developed to infer a simple toy model of star formation history of a galaxy spectrum from the emission and absorption  features. \textsc{starpies} utilises FSPS, the MaNGA DAP and \emph{emcee} in order to provide the inferred $[Z, t_q, \tau]$ parameters with which to describe the exponentially declining quenching history of the input spectral features. This code was written for use on the MaNGA spectral data cubes but can be used for any scenario where a spectrum has been obtained, or spectral feature measurements have been provided. 
\end{abstract}

\begin{keywords}
software -- description
\end{keywords}

\section{Introduction}

Whilst there are many codes which provide a full spectral fit to a galaxy spectrum in order to determine its SFH, there are few providing a simpler, quicker inference of a toy model of star formation history (SFH). 

Here we present an open source \emph{Python} software which can infer a simple toy model of SFH from the absorption and emission features of a galaxy (or IFU) spectrum. 

We describe our SFH model (Section~\ref{sec:sfh}) and our code, \textsc{starpies} through generation (Section~\ref{sec:fsps}) and spectral fit of synthetic spectra (Section~\ref{sec:dap}), using a Markov Chain Monte Carlo method (Section~\ref{sec:emcee}) and pruning methods (Section~\ref{sec:pruning}) outputs `best fit' parameters to describe the SFH in Section~\ref{sec:output}. We also describe the rigorous testing procedures applied to \textsc{starpies} in Section~\ref{sec:test}.   

\section{Description of Code}\label{sec:code}

\subsection{Star Formation History Model}\label{sec:sfh}

The SFH used in this code was first described in \cite{smethurst15}. We have reproduced its descroption here. The quenched star formation history of a galaxy can be simply modelled as an exponentially declining star formation rate (SFR) across cosmic time as:
\begin{equation}\label{sfh}
SFR =
\begin{cases}
I_{sfr}(t_q) & \text{if } t \leq t_q \\
I_{sfr}(t_q) \times exp{\left( \frac{-(t-t_{q})}{\tau}\right)} & \text{if } t > t_q 
\end{cases}
\end{equation}
where $t_{q}$ is the onset time of quenching, $\tau$ is the timescale over which the quenching occurs and $I_{sfr}$ is an initial constant star formation rate dependent on $t_q$.  A smaller $\tau$ value corresponds to a rapid quench, whereas a larger $\tau$ value corresponds to a slower quench. This model is clearly not a fully hydrodynamical simulation, it is a deliberately simple model built in order to test our understanding of the evolution of galaxy populations. This SFH model has previously been shown to appropriately characterise quenching galaxies \citep{weiner06, martin07, noeske07,schawinski14}. For galaxies which are still star forming, this model results in a constant SFR.

Here, I assume that all galaxies formed at a time $t=0~\rm{Gyr}$ with an initial burst of star formation, $I_{sfr}(t_q)$. This initial constant star formation rate must be defined in order to ensure the `model' galaxy  has a reasonable stellar mass by $z\sim0$. This value will be dependent on the epoch at which quenching is modelled to occur, hence the dependence of this initial star formation rate on quenching time in Equation~\ref{sfh}. To tackle this problem, I looked to the literature; \citet[][Equation 1]{peng10} define a relation between the average specific SFR ($\rm{sSFR}=SFR/M_*$) and redshift by fitting to measurements of the mean sSFR of blue star forming galaxies from SDSS, zCOSMOS and literature values from \cite{elbaz07} and \cite{daddi07} measured at increasing redshifts with data from the GOODS survey:
\begin{equation}\label{eq:peng}
sSFR(m,t) = 2.5 \left( \frac{m}{10^{10} M_{\odot}} \right)^{-0.1} \left(\frac{t}{3.5 ~\rm{Gyr}}\right)^{-2.2} \rm{Gyr}^{-1}.
\end{equation}
Beyond $z \sim 2$ the characteristic SFR flattens and is roughly constant back to $z\sim6$. This flattening can be seen across similar observational data \citep{peng10, gonzalez10, bethermin12}; the cause is poorly understood but may reflect a physical limit to the sSFR of a galaxy. 


\begin{figure*}
\centering
\includegraphics[width=\textwidth]{../figures/example_spectra_fit.pdf}
\caption{Example synthetic spectra constructed using FSPS, shown by the black solid line, along with the fit returned by the MaNGA DAP (i.e. ppxf, emission lines and absorption features) shown by the red dashed line. }
\label{fig:spectrafit}
\end{figure*}

Motivated by these observations, the relation defined in \citet{peng10} is taken up to a cosmic time of $t=3~\rm{Gyr}$ ($z \sim 2.3$) and prior to this the value of the sSFR at $t=3~\rm{Gyr}$ is used. At the point of quenching, $t_{q}$, the SFH models are therefore defined to have an $I_{sfr}(t_q)$ which lies on this relationship for the sSFR, for a galaxy with mass, $m = 10^{10.27} M_{\odot}$. This choice of $I_{sfr}(t_q)$ is an important one, however does not impact on the predicted spectral features output by the model as it is merely a normalisation factor on the SFH. $[t_q, \tau]$, which set the shape of the SFH, and $Z$ which can affect the strength of a spectral feature are the crucial parameters.

\subsection{Synthetic spectra generation}\label{sec:fsps}


We then employ stellar population synthesis models (SPS) in order to construct synthetic spectra with known SFHs as defined in Section~\ref{sec:sfh}. 


\subsection{Measuring the synthetic spectral features}\label{sec:dap}

\subsection{Choosing which spectral features to use}

\begin{figure*}
\centering
\includegraphics[width=\textwidth]{../figures/fsps_mangadap_D4000_MgFe_hbeta_hdeltaA_EWs_halpha_OII_one_t_one_Z.png}
\caption{The variation of model spectral features across the logarithmically binned two dimensional $[t_q, \tau]$ parameter space measured at $t_{obs}=13.6\rm{Gyr}$ and solar metallicity, $Z=Z_{\odot}$. The features shown from left to right are the $D4000$, $H\beta$, $H\delta_A$ and $MgFe`$ spectral absorption indices and the equivalent width of both $H\alpha$ and $[OII]$ emission lines. This figure shows how each feature is sensitive to the changing SFH and how they can be used to break the degeneracies that plague photometric studies of SFH. }
\label{fig:rainbow}
\end{figure*}

\subsection{Bayesian inference of SFH parameters}\label{sec:emcee}

For the SFH problem at hand, using a Bayesian approach requires consideration of all possible combinations of the model parameters $\theta \equiv [Z, t_{q}, \tau]$ (the hypothesis in this instance). Assuming that all galaxies formed at $t=0~\rm{Gyr}$, we can assume that the `age' of a spectrum is equivalent to an observed time, $t^{obs}_{k}$. I then used this  `age' to calculate the \emph{predicted}, $p$, spectral features at this cosmic time for a given combination of $\theta$: $\overline{d}_{s,p}(\theta_k, t^{obs}_{k})$ for each of the six spectral features: $\rm{EW}[H\alpha]$, $\rm{EW}[OII]$, $D4000$, $H\beta$, $H\delta_A$ and $MgFe'$. The predicted spectral features can now directly be compared with input observed spectral features, so that for a single spectrum $k$ with features $\overline{d}_{k} = \{s_k\}$, with length $S$, the likelihood of a given model $P(d_{k}|\theta_k, t^{obs}_{k})$ to be:


% \begin{multline}\label{like}
% P(d_{k}|\theta_k, t^{obs}_{k}) = \frac{1}{\sqrt{2\pi\sigma_{opt, k}^2}}\frac{1}{\sqrt{2\pi\sigma_{NUV, k}^2}} \\ \exp{\left[ - \frac{(d_{opt, k} - d_{opt, p}(\theta_k, t_{k}^{obs}))^2}{\sigma_{opt, k}^2} \right]} \\ \exp{\left[ - \frac{(d_{NUV, k} - d_{NUV, p}(\theta_k, t_{k}^{obs}))^2}{\sigma_{NUV, k}^2} \right]}.
% \end{multline}

\begin{multline}\label{like}
P(\overline{d}_{k}|\theta_k, t^{obs}_{k}) = \\ \prod_{s=1}^{S} \frac{1}{\sqrt{2\pi\sigma_{s, k}^2}} \exp{\left[ - \frac{(d_{s, k} - d_{s, p}(\theta_k, t_{k}^{obs}))^2}{\sigma_{s, k}^2} \right]}
\end{multline}

Here I have assumed that $P(d_{s, k}|\theta_k, t^{obs}_{k})$ are all independent of each other and that the errors on the observed features, $\sigma_{s, k}$, are also independent (a simplifying assumption but difficult to otherwise constrain). To obtain the probability of a combination of $\theta$ values given the data: $P(\theta_k|\overline{d}_k, t^{obs})$, i.e. how likely a single SFH model is  given the observed spectral features of a spectrum, I utilise Bayes' theorem as:
 \begin{equation}\label{big}
P(\theta_k|\overline{d}_k, t^{obs}) = \frac{P(\overline{d}_k|\theta_k, t^{obs})P(\theta_k)}{\int P(\overline{d}_k |\theta_k, t^{obs})P(\theta_k) d\theta_k}.
\end{equation}
I assume a flat prior on the model parameters so that:
\begin{equation}\label{prior}
P(\theta_k) =
\begin{dcases}
1 & \text{if } 0 < Z [Z_{\odot}] \leq 1.5 \text{ and } 0 < t_q ~\rm{[Gyr]}~ \leq 13.8 ~ \text{ and } ~ 0 < \tau  ~\rm{[Gyr]}~ \leq 6\\
0 & \text{otherwise.} \\
\end{dcases}
\end{equation}

As the denominator of Equation~\ref{big} is a normalisation factor, comparison between likelihoods for two different SFH models (i.e., two different combinations of $\theta_k = [Z, t_q, \tau]$) is equivalent to a comparison of the numerators. Markov Chain Monte Carlo (MCMC; \citealt{mackay03, emcee13, GW10}) analysis provides a robust comparison of the likelihoods between $\theta$ values.

MCMC allows for a more efficient exploration of the parameter space than a simple $\chi^2$ analysis by avoiding those areas with low likelihood. A large number of `walkers' are started at an initial position (i.e. an initial hypothesis, $\theta$), where the likelihood is calculated; from there they individually `jump' a randomised distance to a new area of parameter space. If the likelihood in this new position is greater than the original position then the `walkers' accept this change in position. Any new position then influences the direction of the  `jumps' of other walkers (this is the case in ensemble MCMC as used in this investigation but not for simple MCMC, which is much slower at converging). This is repeated for the defined number of steps after an initial `burn-in' phase. The length of this burn-in phase is determined after sufficient experimentation to ensure that the `walkers' have converged on a region of parameter space. Here we use \emph{emcee},\footnote{\url{dan.iel.fm/emcee/}} a \emph{Python} module which implements an affine invariant ensemble sampler to explore the parameter space, written by \cite{emcee13}. \emph{emcee} outputs the positions of these `walkers' in the parameter space, which are analogous to the regions of high posterior probability. 

For each run of \textsc{starpies}, the inference run is initialised with 100 walkers with a burn-in phase of 500 steps before a main run of 100 steps. Acceptance fractions for each walker are difficult to estimate due to the fact that walkers often get stuck in local minima during a run (see Section~\ref{sec:pruning} for more information). 

I used the \emph{Python} programming language to code the routine outlined above into a package named \textsc{starpies} ~which has been released with an open source license. The required inputs for \textsc{starpies} to run on a single spectrum are at least one, if not all, of $\rm{EW}H\alpha$, $\rm{EW}[OII]$, $D4000$, $H\beta$, $H\delta_A$ and $MgFe`$ and their associated errors and the redshift, $z$. 


\subsection{Pruning}\label{sec:pruning}

After running \textsc{starpies} and upon inspection of the walker positions it became apparent that the walkers of \emph{emcee} would often get stuck in local minima. We therefore implemented a pruning method, as described in \cite{hou12}, in order to remove those walkers in local minima leaving only the global minima from which to derive inferred SFH parameters. The method outlined in \cite{hou12} is a simple one dimensional clustering method wherein the average negative log-likelihood for each walker is collected. This results in $L$ numbers:
\begin{equation}
\overline{l}_k = \frac{1}{T} \sum^{T}_{t=1} l(\vec{\theta}_k(t)|D),
\end{equation}
where T is the total number of steps each walker, $k$, takes. These $L$ numbers, $\overline{l}_k$ are therefore characteristic of the well which walker $k$ is in, so that walkers in the same well will have similar $\overline{l}_k$ (see Figure~\ref{fig:localminima} in which walkers are coloured by their characteristic $\overline{l}_{(k)}$ value). 


\begin{figure}
\centering
\includegraphics[width=0.495\textwidth]{../figures/pruning_features.png}
\caption{This figure shows the walker positions marginalized over the $Z$ dimension into the two dimensional model $[t_q, \tau]$ space and coloured by their log probability value. The higher the value of their log probability, the more likely the model is. The lower values of log probability for some groups of walkers suggests that these are indeed stuck in local minima. These clusters of walkers in local minima can be `pruned' (see Section~\ref{sec:pruning}) away to leave only the global minimum in the final output.}
\label{fig:localminima}
\end{figure}

The walkers are all then ranked in order of decreasing average log likelihood, $\overline{l}_{(k)}$, or increasing $- \log \overline{l}_{(k)}$. If there are big jumps in the $- \log \overline{l}_{(k)}$, these are easy to spot and are indicative of areas where walkers have got stuck in local minima.The difference in $- \log \overline{l}_{(k)}$ for every adjacent pair of walkers is then calculated. The first pair whose difference is a certain amount times bigger than the average difference previously is then identified like so:
\begin{equation}
-\log \overline{l}_{(j+1)} + \log \overline{l}_{(j)} > Const − \frac{\log \overline{l}_{(j)} + log \overline{l}_{(1)}}{j - 1}.
\end{equation}
All the walkers with with $k>j$ are thrown away and only the ones with $k \leq j$ are kept after being identified as part of the global minimum. This can be seen in Figure~\ref{fig:comparepruning} wherein the walker positions at each step before pruning in the burn-in phase are shown in comparison to those after pruning in the main run stage.

\begin{figure*}
\centering
\includegraphics[width=0.495\textwidth]{../figures/walkers_steps_burn_in_wihtout_pruning_25.pdf}
\includegraphics[width=0.495\textwidth]{../figures/walkers_steps_pruning_25.pdf}
\caption{The positions traced by the \emph{emcee} walkers with step number (i.e. time) in each of the $[Z, t_q, \tau]$ dimensions during the burn in phase before pruning (left) and the post burn-in phase after pruning (right). The red lines show the known true values in each panel. Walkers have got stuck in local minima (see Figure±\ref{fig:localminima}) but some have managed to find the global minimum which can be seen more clearly in the right hand panels.}
\label{fig:comparepruning}
\end{figure*}


\section{Output of Code}\label{sec:output}

The burn-in and main run walker positions and posterior probabilities at each step are written to disc by \textsc{starpies}. From this three dimensional MCMC chain charting the $[Z, t_q, \tau]$ positions of the walkers around parameter space, the `best fit' $[Z, t_q, \tau]$ values along with their uncertainties can be determined from the 16th, 50th and 84th percentile values of the walker positions. An example output from \textsc{starpies} for a single synthetic spectrum constructed with the FSPS models (see Section~\ref{sec:fsps}) is shown in Figure~\ref{fig:output}. This figure is also written to disc by \textsc{starpies} upon completion of a run on a single spectrum.  

\begin{figure*}
\centering
\includegraphics[width=\textwidth]{../figures/starpy_output_corner_test_pruning_25.png}
\caption{Example output from \textsc{starpies} showing the posterior probability function traced by the MCMC walkers across the three dimensional parameter space $[Z, t_q, \tau]$. Dashed lines show the 18th, 50th and 64th percentile of each distribution function which can be interpreted as the `best fit' with $±1\sigma$. The blue lines show the known true values which \textsc{starpies} has managed to recover.}
\label{fig:output}
\end{figure*}


\section{Testing}\label{sec:test}

\subsection{Testing precision}

In order to test that \textsc{starpies} can find the correct quenched SFH model for a given set of spectral features, 25 synthesised galaxy spectra were created with known SFHs (i.e. known values of $\theta = [Z, t_q, \tau]$) from which spectral features were generated using the FSPS models (see Section~\ref{sec:fsps}. These were input into \textsc{starpies} to test whether the known values of $\theta$ were reproduced, within error, for each of the 25 synthesised galaxies. Figure~\ref{fig:test_mosaic} shows the results for each of these synthesised galaxies, with the known values of $\theta$ shown by the red lines. In only one case for the $\tau$ parameter this red line does not fall within the 16th and 84th percentile values shown by the blue dashed lines (see bottom right panel). However, on inspection, this SFH was a constant SFR that had not yet quenched and so the posterior probability function returned for the $\tau$ parameter is very broad as \textsc{starpies} does not have any information with which to constrain this parameter. In all cases the intersection of the red lines (i.e. the known or true values input) resides within the parameter space explored by the walkers left over after pruning, which trace the global minimum of the posterior probability. Therefore \textsc{starpies} succeeds in precisely locating the true parameter values within the degeneracies of the SFH model for known values. 

\begin{figure*}
\centering
\includegraphics[width=\textwidth]{../code/test_log/mosaic_spec_starpy_test_0-874128238232_log_BH.pdf}
\caption{Results from \textsc{starpies} for an array of synthesised galaxies with known true $[Z, t_q, \tau]$ values (marked by the solid red lines) assuming an error on the input spectral measurements of the average error on the measured MaNGA spectra measurements. {\check Pruning has been applied?} In each case \textsc{starpies} has succeeded in locating the true parameter values within the degeneracies of the star formation history model.}
\label{fig:test_mosaic}
\end{figure*}

\subsection{Testing accuracy}

We have shown in the previous section that \textsc{starpies} is precise in returning known values for SFHs, however how can we be sure that it is returning an accurate result? 

\subsection{Testing performance with different known SFHs}

Obviously, not all galaxies will be accurately described by an exponentially quenching SFH. In special use cases (for example studying post starburst galaxies) a different SFH may be defined by the user by replacing the \texttt{expsfh} function with their own. 

However, we have also tested how \textsc{starpies} behaves when known SFHs of different shapes to the exponentially quenching model it assumes are input. We tested a constant, burst, many burst, normal and log-normal models of SFH (see Figure~\ref{fig:differentSFHs}) all of which are often used in the literature to model simple SFHs. 

We found that \textsc{starpies} was always sensitive to the most recent epoch of star formation or quenching. For the constant SFR model, \textsc{starpies} returned a very recent $t_q$ and a very large $\tau$, i.e. a galaxy which has had constant SFR up until very recently at which point it started to decline very slowly. For the burst and many-burst models, \textsc{starpies} returns a constant SFR up until the peak of the last burst at which point quenching happens very rapidly. Similarly for the log normal and normal SFHs, \textsc{starpies} returns a best fit SFH with constant SFR until the peak of the normal and which point it declines at a rate comparable to the drop off of the Gaussian SFH. 

\begin{figure}
\centering
\includegraphics[width=0.475\textwidth]{../figures/different_SFHs_to_test.png}
\caption{The shapes of the different known SFHs input into \textsc{starpies}.}
\label{fig:differentSFHs}
\end{figure}

\subsection{Testing against previously derived SFHs}

\section{Conclusions}

\bibliographystyle{mn2e}
\bibliography{refs}  

\end{document}
